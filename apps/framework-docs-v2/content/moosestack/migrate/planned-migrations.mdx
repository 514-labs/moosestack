---
title: Planned Migrations
description: Reference documentation for the Planned Migrations system in Moose.
order: 6
category: olap
---

import { Callout } from "@/components/mdx";

# Planned Migrations

**Planned migrations** are the production-grade schema evolution mechanism in Moose. Unlike auto-inferred migrations, this system separates the *generation* of schema changes from their *execution*, introducing a reviewable artifact (the plan) into your deployment lifecycle.

## Overview

Planned migrations provide safety and determinism by creating a static file describing exactly what will happen to your database.

| Feature | Description |
| :--- | :--- |
| **Determinism** | The migration plan is fixed once generated. It does not change based on when it runs. |
| **Drift Detection** | Moose captures the production state at generation time. If the database changes before application, the migration aborts. |
| **Reviewability** | The generated YAML file allows human review of every operation (e.g., "Drop Column") before execution. |
| **Version Control** | Plans are committed to Git, creating an audit trail of all schema changes. |

## Workflow

The planned migration lifecycle consists of four distinct stages:

1.  **Code Change:** You modify your data models (tables, views) in your Moose project.
2.  **Generation:** You run the CLI to compare your local code against the production database.
3.  **Review:** Moose produces a `migrations/` directory containing the plan. You review and commit these files.
4.  **Application:** The plan is applied to the database, either serverless (via `moose migrate` CLI command) or server runtime (via `moose prod` command).

## Generated Artifacts

Running the generation command produces three files in the `migrations/` directory.

| File | Purpose |
| :--- | :--- |
| `plan.yaml` | The imperative list of operations (e.g., `AddTableColumn`) to execute. See [Plan Reference](/moosestack/migrate/reference). |
| `remote_state.json` | A snapshot of the production database schema at the time of generation. Used to detect drift. |
| `local_infra_map.json` | A snapshot of your local code's schema definitions. Used to validate the plan against the code. |

## Configuration

Planned migrations are enabled via the `ddl_plan` feature flag in your project configuration.

```toml filename="moose.config.toml"
[features]
olap = true
ddl_plan = true
```

## CLI Command Reference

The `moose generate migration` command compares your local code against a production environment. The arguments you use depend on your [deployment model](/moosestack/migrate#deployment-models-service-vs-library).

### For Server Runtime (`moose prod`)

Use this if you are deploying a full Moose server (e.g., Boreal, AWS, or your own container). You connect to the **Admin API** of the running service.

```bash
moose generate migration --url <ADMIN_API_URL> --token <ADMIN_TOKEN> --save
```

| Option | Description |
| :--- | :--- |
| `--url` | The endpoint of your production Moose Admin API. |
| `--token` | The authentication token for the Admin API. |
| `--save` | Writes the generated plan to the `migrations/` directory. Without this, it performs a dry run. |

### For Serverless Model (`moose migrate`)

Use this if you are integrating Moose into an existing application and managing ClickHouse yourself. You connect directly to the **ClickHouse database**.

```bash
moose generate migration --clickhouse-url <CLICKHOUSE_CONNECTION_STRING> --save
```

| Option | Description |
| :--- | :--- |
| `--clickhouse-url` | Direct connection string (e.g., `clickhouse://user:pass@host:9440/db`). |
| `--save` | Writes the generated plan to the `migrations/` directory. Without this, it performs a dry run. |

## Drift Detection

Drift occurs when the target database's schema changes between the time you generate a plan and the time you apply it.

**How it works:**
1. `moose generate` writes the current DB state to `remote_state.json`.
2. `moose migrate` (serverless) or `moose prod` (server runtime) compares `remote_state.json` with the *current* DB state.
3. If they differ (hash mismatch), the migration **aborts**.

**Resolution:**
To fix drift, you must regenerate the plan against the new production state.

```bash
# Regenerate to accept the new state
moose generate migration ... --save
```

## See Also

- [Migration Plan Reference](/moosestack/migrate/reference) - Detailed syntax of `plan.yaml`.
- [Serverless (moose migrate)](/moosestack/migrate/apply-planned-migrations-cli) - Execution guide.
- [Server Runtime](/moosestack/migrate/apply-planned-migrations-service) - Execution guide.
