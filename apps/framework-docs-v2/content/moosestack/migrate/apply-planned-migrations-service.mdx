---
title: Apply Planned Migrations with Moose Prod
description: Let the Moose runtime execute plan.yaml automatically during application startup
order: 14
category: olap
---

import { Callout } from "@/components/mdx";

# Apply Planned Migrations with Moose Prod

When you deploy the full MooseStack runtime (`moose prod`), the server automatically runs your planned migrations during startup. This page explains how to confirm the plan is ready, what happens at boot, and how to respond to drift failures.

<Callout type="info" title="Need a plan first?" href="/moosestack/migrate/planned-migrations" ctaLabel="Generate plan" compact>
Make sure `plan.yaml`, `remote_state.json`, and `local_infra_map.json` are up to date before you ship code.
</Callout>

## When to Use

- You deploy Moose as a managed runtime (Moose Prod or a containerized service)
- You want migrations to run automatically during each rollout
- Your platform team already handles application startup orchestration

## Prerequisites

- `ddl_plan = true` and `olap = true` in `moose.config.toml`
- An approved plan committed to `migrations/`
- Access to update the Moose Prod deployment (SSH, Kubernetes, ECS, etc.)
- Admin API authentication configured (required for generating future plans)

---

## Step 1 · Ship the Approved Plan

Ensure the runtime receives the same commit that reviewers approved:

```bash
git checkout main
git pull origin main
# Build or publish your release artifact as you normally would
```

Deploy the artifact (container image, binary, etc.) to your production environment.

---

## Step 2 · Start `moose prod`

On the server (or inside your orchestrator), run:

```bash filename="Terminal" copy
moose prod
```

During startup Moose will:

1. Detect that `ddl_plan = true`
2. Load `migrations/plan.yaml`
3. Compare `remote_state.json` with the actual ClickHouse state
4. Compare `local_infra_map.json` with the code bundled in the deployment
5. Execute the plan in order (teardowns, setups, modifications)
6. Continue booting application services

<Callout type="warning" title="Startup fails on drift">
If the ClickHouse schema changed since you generated the plan, Moose exits before starting any services. Regenerate the plan against the current production state, commit the new files, redeploy, and restart `moose prod`.
</Callout>

---

## Step 3 · Verify the Deployment

- Confirm the `moose prod` logs show the migration block executing successfully
- Run smoke tests or health checks for your application
- Optional: connect to ClickHouse and inspect the affected tables to ensure schema changes landed

---

## Handling Failures

**Plan validation failed**  
The runtime detected a mismatch between `local_infra_map.json` and your shipped code. Rebuild your artifact to include the same schema definitions used when the plan was generated.

**Migration step failed mid-run**  
Moose stops immediately and surfaces the ClickHouse error. Fix the plan (or add `RawSql` remediation), regenerate, redeploy, and retry.

**Need to rerun after hotfix**  
It is safe to rerun `moose prod`; the plan only executes if the snapshots still match. Once applied successfully, consider deleting or rotating the plan files to avoid accidental replays.

---

## Next Steps

- [Apply planned migrations with the CLI](/moosestack/migrate/apply-planned-migrations-cli) – Manual control for existing applications.
- [Review & edit planned migrations](/moosestack/migrate/reference) – Adjust operations before the next deployment.

