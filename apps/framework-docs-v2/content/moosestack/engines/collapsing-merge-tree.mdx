---
title: CollapsingMergeTree
description: ClickHouse table engine for collapsing state-change rows
order: 7
category: reference
---

import { LanguageTabs, LanguageTabContent, Callout } from "@/components/mdx";

# CollapsingMergeTree

`CollapsingMergeTree` is a MergeTree-family engine that collapses pairs of rows during background merges using a required `sign` column (where `1` is a “state” row and `-1` is a “cancel” row). The merge behavior is defined by ClickHouse.

## When to Use

- Track object state changes without running ClickHouse UPDATEs
- Model “current state” from a stream of changes (append-only writes)
- Reduce storage by collapsing old states during merges

## Usage

<LanguageTabs>
  <LanguageTabContent value="typescript">
```ts filename="CollapsingTable.ts" copy
import { Key, OlapTable, ClickHouseEngines, Int8 } from "@514labs/moose-lib";

interface UserActivity {
  userId: Key<string>;
  pageViews: number;
  duration: number;
  sign: Int8; // Required: 1 = state row, -1 = cancel row
}

const userActivity = new OlapTable<UserActivity>("user_activity", {
  engine: ClickHouseEngines.CollapsingMergeTree,
  sign: "sign",
  orderByFields: ["userId"],
});
```
  </LanguageTabContent>
  <LanguageTabContent value="python">
```py filename="CollapsingTable.py" copy
from moose_lib import Key, Int8, OlapTable, OlapConfig
from moose_lib.blocks import CollapsingMergeTreeEngine
from pydantic import BaseModel

class UserActivity(BaseModel):
    user_id: Key[str]
    page_views: int
    duration: int
    sign: Int8  # Required: 1 = state row, -1 = cancel row

user_activity = OlapTable[UserActivity]("user_activity", OlapConfig(
    order_by_fields=["user_id"],
    engine=CollapsingMergeTreeEngine(sign="sign"),
))
```
  </LanguageTabContent>
</LanguageTabs>

## Configuration Options

| Option | Type | Description |
|--------|------|-------------|
| `orderByFields` | `string[]` | Sorting key used by ClickHouse for grouping rows |
| `sign` | `string` | Name of the `Int8` sign column (`1` = state, `-1` = cancel) |

## Example: Modeling State Changes

To update an object, write two rows:

1. A **cancel** row (`sign = -1`) that matches the prior state’s sorting key
2. A **state** row (`sign = 1`) with the new state

## Collapsing Behavior

By default, collapsing happens during ClickHouse background merges. To return fully-collapsed results, ClickHouse documents two common approaches:

- Aggregate with sign (recommended for analytics queries)
- Use `FINAL` at read time (less efficient; typically avoid on large scans)

<LanguageTabs>
  <LanguageTabContent value="typescript">
```ts
import { sql } from "@514labs/moose-lib";

// Example: compute fully-collapsed metrics via sign-aware aggregation
const collapsed = sql`
  SELECT
    userId,
    sum(pageViews * sign) AS pageViews,
    sum(duration * sign)  AS duration
  FROM user_activity
  GROUP BY userId
  HAVING sum(sign) > 0
`;
```
  </LanguageTabContent>
  <LanguageTabContent value="python">
```py
COLLAPSED_SQL = """
  SELECT
    user_id,
    sum(page_views * sign) AS page_views,
    sum(duration * sign)   AS duration
  FROM user_activity
  GROUP BY user_id
  HAVING sum(sign) > 0
"""
```
  </LanguageTabContent>
</LanguageTabs>

<Callout type="info" title="ClickHouse behavior">
For full details (including the required `Sign` column, algorithm, and `FINAL` semantics), see the ClickHouse docs: [CollapsingMergeTree table engine](https://clickhouse.com/docs/engines/table-engines/mergetree-family/collapsingmergetree).
</Callout>

## See Also

- [VersionedCollapsingMergeTree](/moosestack/engines/versioned-collapsing-merge-tree) — Collapsing with an explicit version column
- [MergeTree](/moosestack/engines/merge-tree) — Append-only baseline engine
- [Replicated Engines](/moosestack/engines/replicated) — High availability variants
