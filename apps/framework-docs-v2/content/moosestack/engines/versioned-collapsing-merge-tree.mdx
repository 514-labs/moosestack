import { LanguageTabs, LanguageTabContent, Callout } from "@/components/mdx";

#### VersionedCollapsingMergeTree
Use `VersionedCollapsingMergeTree` when you need collapsing with out-of-order inserts. The version column ensures correct collapse ordering regardless of insertion order:

<LanguageTabs>
  <LanguageTabContent value="typescript">
```ts filename="VersionedCollapsingTable.ts" copy
import { OlapTable, ClickHouseEngines, Int8 } from "@514labs/moose-lib";

interface ExampleSchema {
  id: Key<string>;
  value: float;
  timestamp: datetime;
  sign: Int8;     // Required: 1 = state row, -1 = cancel row
  version: number; // Required: version for ordering state changes
}

// Track user state with versioned collapsing
const exampleTable = new OlapTable<ExampleSchema>("versioned_collapsing_merge_tree_table", {
  engine: ClickHouseEngines.VersionedCollapsingMergeTree,
  orderByFields: ["id"],
  sign: "sign",
  ver: "version"
});
```
  </LanguageTabContent>
  <LanguageTabContent value="python">
```py filename="VersionedCollapsingTable.py" copy
from moose_lib import Key, Int8, OlapTable, OlapConfig
from moose_lib.blocks import VersionedCollapsingMergeTreeEngine
from pydantic import BaseModel
from datetime import datetime

class ExampleSchema(BaseModel):
    id: str
    value: float
    timestamp: datetime
    sign: Int8      # Required: 1 = state row, -1 = cancel row
    version: int    # Required: version for ordering state changes

# Create a versioned collapsing merge tree table
example_table = OlapTable[ExampleSchema]("versioned_collapsing_merge_tree_table", OlapConfig(
    order_by_fields=["id"],
    engine=VersionedCollapsingMergeTreeEngine(sign="sign", ver="version")
))
```
  </LanguageTabContent>
</LanguageTabs>

<Callout type="warning" title="CollapsingMergeTree vs VersionedCollapsingMergeTree">
**CollapsingMergeTree**: Requires strictly consecutive insertion order. Use when you control insertion order (e.g., single writer).

**VersionedCollapsingMergeTree**: Uses a version column to handle out-of-order inserts. Use when multiple threads/sources insert data or order isn't guaranteed.

Both engines require the `sign` column to be `Int8` type.

For more details, see the ClickHouse documentation on [CollapsingMergeTree](https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/collapsingmergetree) and [VersionedCollapsingMergeTree](https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/versionedcollapsingmergetree).
</Callout>

## See Also
- [CollapsingMergeTree](/moosestack/engines/collapsing-merge-tree)