import { Callout, BulletPointsCard, CheckmarkBullets, LanguageSwitcher, TypeScript, Python } from "@/components";
import { Tabs } from "nextra/components";

#### Deduplication (`ReplacingMergeTree`)
Use the `ReplacingMergeTree` engine to keep only the latest record for your designated sort key:

<TypeScript>
```ts filename="DeduplicatedTable.ts" copy
// Basic deduplication
const table = new OlapTable<Record>("table", {
  engine: ClickHouseEngines.ReplacingMergeTree,
  orderByFields: ["id"]
});

// With version column (keeps record with highest version)
const versionedTable = new OlapTable<Record>("table", {
  engine: ClickHouseEngines.ReplacingMergeTree,
  orderByFields: ["id"],
  ver: "updated_at"  // Column that determines which version to keep
});

// With soft deletes (requires ver parameter)
const softDeleteTable = new OlapTable<Record>("table", {
  engine: ClickHouseEngines.ReplacingMergeTree,
  orderByFields: ["id"],
  ver: "updated_at",
  isDeleted: "deleted"  // UInt8 column: 1 marks row for deletion
});
```
</TypeScript>

<Python>
```py filename="DeduplicatedTable.py" copy
from moose_lib import Key, OlapTable, OlapConfig
from moose_lib.blocks import ReplacingMergeTreeEngine

class Record(BaseModel):
    id: Key[str]
    updated_at: str  # Version column
    deleted: int = 0  # Soft delete marker (UInt8)

# Basic deduplication
table = OlapTable[Record]("table", OlapConfig(
  order_by_fields=["id"],
  engine=ReplacingMergeTreeEngine()
))

# With version column (keeps record with highest version)
versioned_table = OlapTable[Record]("table", OlapConfig(
  order_by_fields=["id"],
  engine=ReplacingMergeTreeEngine(ver="updated_at")
))

# With soft deletes (requires ver parameter)
soft_delete_table = OlapTable[Record]("table", OlapConfig(
  order_by_fields=["id"],
  engine=ReplacingMergeTreeEngine(
    ver="updated_at",
    is_deleted="deleted"  # UInt8 column: 1 marks row for deletion
  )
))
```
</Python>

<Callout type="warning" title="Deduplication Caveats">
ClickHouse's ReplacingMergeTree engine runs deduplication in the background AFTER data is inserted into the table. This means that duplicate records may not be removed immediately.

**Version Column (`ver`)**: When specified, ClickHouse keeps the row with the maximum version value for each unique sort key.

**Soft Deletes (`is_deleted`)**: When specified along with `ver`, rows where this column equals 1 are deleted during merges. This column must be UInt8 type.

For more details, see the [ClickHouse documentation](https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replacingmergetree).
</Callout>

