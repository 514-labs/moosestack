import { LanguageTabs, LanguageTabContent, Callout } from "@/components/mdx";

#### In-Memory Buffer (`Buffer`)
The `Buffer` engine provides an in-memory buffer that flushes data to a destination table based on time, row count, or size thresholds:

<LanguageTabs>
  <LanguageTabContent value="typescript">
```ts filename="BufferTable.ts" copy
import { OlapTable, ClickHouseEngines } from '@514labs/moose-lib';

// First create the destination table
export const destinationTable = new OlapTable<Record>("destination", {
  engine: ClickHouseEngines.MergeTree,
  orderByFields: ["id", "timestamp"]
});

// Then create buffer that writes to it
export const bufferTable = new OlapTable<Record>("buffer", {
  engine: ClickHouseEngines.Buffer,
  targetDatabase: "local",
  targetTable: "destination",
  numLayers: 16,
  minTime: 10,        // Min 10 seconds before flush
  maxTime: 100,       // Max 100 seconds before flush
  minRows: 10000,     // Min 10k rows before flush
  maxRows: 1000000,   // Max 1M rows before flush
  minBytes: 10485760, // Min 10MB before flush
  maxBytes: 104857600 // Max 100MB before flush
});
```
  </LanguageTabContent>
  <LanguageTabContent value="python">
```py filename="BufferTable.py" copy
from moose_lib import OlapTable, OlapConfig
from moose_lib.blocks import MergeTreeEngine, BufferEngine

# First create the destination table
destination_table = OlapTable[Record]("destination", OlapConfig(
    engine=MergeTreeEngine(),
    order_by_fields=["id", "timestamp"]
))

# Then create buffer that writes to it
buffer_table = OlapTable[Record]("buffer", OlapConfig(
    engine=BufferEngine(
        target_database="local",
        target_table="destination",
        num_layers=16,
        min_time=10,        # Min 10 seconds before flush
        max_time=100,       # Max 100 seconds before flush
        min_rows=10000,     # Min 10k rows before flush
        max_rows=1000000,   # Max 1M rows before flush
        min_bytes=10485760, # Min 10MB before flush
        max_bytes=104857600 # Max 100MB before flush
    )
))
```
  </LanguageTabContent>
</LanguageTabs>

<Callout type="warning" title="Buffer Engine Considerations">
- Data in buffer is **lost if server crashes** before flush
- Not suitable for critical data that must be durable
- Best for high-throughput scenarios where minor data loss is acceptable
- Buffer and destination table must have identical schemas
- Cannot use `orderByFields`, `partitionBy`, or `sampleByExpression` on buffer tables

For more details, see the [ClickHouse Buffer documentation](https://clickhouse.com/docs/en/engines/table-engines/special/buffer).
</Callout>
