---
title: Durable Source Connectors in Moose
description: Readable durable ETL architecture for websocket, API, and database-change sources
languages: ["typescript"]
---

import { FileTree, CTACards, CTACard, Callout } from "@/components/mdx";

# Durable Source Connectors (Supabase + Coinbase examples)

<Callout type="info" title="Status">
This architecture is currently published as an **example**, not a `moose init` template.

Use:

- `examples/websocket-ingestion-poc/moose`

This keeps the connector API surface out of template release paths while we iterate.
</Callout>

<CTACards columns={3}>
  <CTACard
    title="Runtime"
    description="Shared durable ingestion primitive"
    ctaLink="#shared-durable-runtime"
    ctaLabel="Open"
    Icon="Eye"
  />
  <CTACard
    title="Supabase"
    description="Postgres changes connector"
    ctaLink="#supabase-connector"
    ctaLabel="View"
    Icon="Rocket"
  />
  <CTACard
    title="Coinbase"
    description="Websocket connector"
    ctaLink="#coinbase-connector"
    ctaLabel="View"
    Icon="BinaryTree"
  />
</CTACards>

---

## Shared durable runtime

Shared primitive files:

- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/types.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/source-definition.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/resource-definition.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/runner.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/checkpoint-store.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/sink-writer.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/connector-pipeline.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/connector-definition.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/pipeline-workflow.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/backoff.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/disconnect-signal.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/event-processor.ts`
- `examples/websocket-ingestion-poc/moose/app/connectors/shared/durable-pipeline/run-loop.ts`

Runtime guarantees:

1. Start/reconnect loop.
2. At-least-once processing.
3. Checkpoint persisted only after successful sink write.
4. Clean stop on workflow cancellation.

---

## Connector shape (source owns resources)

Each connector folder follows the same file roles:

1. `source.ts`
- Define source with `defineSource({ name, resources, start })`.
- Connection/auth/subscription logic only.
- Emit events with `onEvent({ resource, payload })`.

2. `resources/*.ts`
- One resource per file.
- Declare resource with `defineResource({ name, sink, process })`.
- `process` returns one of:
  - `null` (drop)
  - `{ records }`
  - `{ records, checkpoint }`

3. `pipeline.ts`
- Connector composition with `defineConnector(...)`.
- Pipeline ID, workflow/task names, checkpoint store prefix, reconnect policy.

4. `workflow.ts`
- Export long-running workflow (`timeout: "never"`) for manual run.

---

## Supabase connector

Code:

- `examples/websocket-ingestion-poc/moose/app/connectors/supabase`

Workflow:

- `supabase-cdc-listener`

Run:

```bash
cd examples/websocket-ingestion-poc/moose
npm install
moose dev
```

```bash
export SUPABASE_URL="https://<project-ref>.supabase.co"
export SUPABASE_SERVICE_ROLE_KEY="<service-role-key>"
export SUPABASE_SCHEMA="public"
moose workflow run supabase-cdc-listener
```

Supabase SQL setup:

```sql
create table if not exists public.projects (
  id text primary key,
  name text not null,
  hourly_rate numeric not null,
  updated_at timestamptz not null default now()
);

create table if not exists public.time_entries (
  id text primary key,
  project_id text not null references public.projects(id),
  worker_id text not null,
  hours_worked numeric not null,
  work_date timestamptz not null,
  updated_at timestamptz not null default now()
);

alter publication supabase_realtime add table public.projects;
alter publication supabase_realtime add table public.time_entries;

alter table public.projects replica identity full;
alter table public.time_entries replica identity full;
```

---

## Coinbase connector

Code:

- `examples/websocket-ingestion-poc/moose/app/connectors/coinbase`

Workflow:

- `coinbase-trades-listener`

Run:

```bash
cd examples/websocket-ingestion-poc/moose
export COINBASE_PRODUCTS="BTC-USD,ETH-USD"
export COINBASE_WS_URL="wss://ws-feed.exchange.coinbase.com"
moose workflow run coinbase-trades-listener
```

---

## Monorepo integration with existing TS backend/fullstack app

If you already have a TypeScript backend/fullstack app with Supabase configured:

1. Keep Moose as a sibling package in your monorepo.
- `apps/backend` (or fullstack app)
- `examples/websocket-ingestion-poc/moose` (or copied connector package)

2. Reuse existing env/secrets flow.
- Keep Supabase URL/service key managed by your current secrets system.
- Pass them to Moose as environment variables.

3. Reuse existing generated Supabase types.
- Point `supabase.generated.ts` to your shared generated type package.
- Keep source payload typing and resource processing typed in the same repo.

4. Keep boundaries explicit.
- Source protocol logic in `source.ts`.
- Sink + mapping + checkpoint logic in `resources/*.ts`.
- Pipeline/workflow wiring in `pipeline.ts` and `workflow.ts`.

---

## Reference structure

<FileTree>
  <FileTree.Folder name="examples" defaultOpen>
    <FileTree.Folder name="websocket-ingestion-poc" defaultOpen>
      <FileTree.Folder name="moose" defaultOpen>
        <FileTree.Folder name="app" defaultOpen>
          <FileTree.Folder name="connectors" defaultOpen>
            <FileTree.Folder name="shared" defaultOpen>
              <FileTree.Folder name="durable-pipeline" defaultOpen>
                <FileTree.File name="checkpoint-store.ts" />
                <FileTree.File name="backoff.ts" />
                <FileTree.File name="connector-definition.ts" />
                <FileTree.File name="connector-pipeline.ts" />
                <FileTree.File name="disconnect-signal.ts" />
                <FileTree.File name="event-processor.ts" />
                <FileTree.File name="pipeline-workflow.ts" />
                <FileTree.File name="resource-definition.ts" />
                <FileTree.File name="run-loop.ts" />
                <FileTree.File name="runner.ts" />
                <FileTree.File name="source-definition.ts" />
                <FileTree.File name="sink-writer.ts" />
                <FileTree.File name="types.ts" />
              </FileTree.Folder>
            </FileTree.Folder>
            <FileTree.Folder name="supabase" defaultOpen>
              <FileTree.File name="pipeline.ts" />
              <FileTree.File name="source.ts" />
              <FileTree.File name="workflow.ts" />
              <FileTree.Folder name="resources" defaultOpen>
                <FileTree.File name="projects.ts" />
                <FileTree.File name="time-entries.ts" />
              </FileTree.Folder>
            </FileTree.Folder>
            <FileTree.Folder name="coinbase" defaultOpen>
              <FileTree.File name="pipeline.ts" />
              <FileTree.File name="source.ts" />
              <FileTree.File name="workflow.ts" />
              <FileTree.Folder name="resources" defaultOpen>
                <FileTree.File name="matches.ts" />
              </FileTree.Folder>
            </FileTree.Folder>
          </FileTree.Folder>
        </FileTree.Folder>
      </FileTree.Folder>
    </FileTree.Folder>
  </FileTree.Folder>
</FileTree>

## Resources

- [Supabase Realtime Postgres Changes](https://supabase.com/docs/guides/realtime/postgres-changes)
- [Coinbase WebSocket Feed](https://docs.cdp.coinbase.com/exchange/websocket-feed/overview)
- [Moose Workflows](/moosestack/workflows)
- [Moose Olap Tables](/moosestack/olap)
