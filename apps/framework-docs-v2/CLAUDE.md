# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Next.js 15 documentation site for MooseStack with language-specific content (TypeScript & Python), full-text search via Pagefind, feature flags, and analytics. Part of the larger MooseStack monorepo.

## Development Commands

### Setup
**IMPORTANT**: This is a monorepo workspace package. Always install dependencies from the monorepo root:
```bash
cd <monorepo-root>  # Navigate to monorepo root
pnpm install        # Install all workspace dependencies
```

Never run `pnpm install` from `apps/framework-docs-v2/` directly, as this will break the monorepo workspace setup.

### Daily Development
- **Dev server**: `pnpm dev` (starts at localhost:3000)
- **Build**: `pnpm build` (Next.js SSG + search indexing)
- **Lint**: `pnpm lint`
- **Test snippets**: `pnpm test:snippets` (validates code blocks in documentation)

### Build Pipeline
The build process runs in this order:
1. `prebuild`: Validates includes (`validate-includes.ts`) and generates sitemap excludes
2. `build`: Next.js build + Pagefind search indexing
3. `postbuild`: next-sitemap generation

### Search Index
- **Generate search content**: `pnpm run generate:search-content` (creates `.search-index/`)
- **Index search**: `pnpm run index:search` (runs Pagefind indexer)
- Search index is rebuilt automatically during `pnpm build`

## Architecture

### App Structure (Next.js 15 App Router)
```
src/app/
├── (docs)/          # Route group for documentation pages
│   ├── [...slug]/page.tsx          # Dynamic doc routes (e.g., /moosestack/quickstart)
│   ├── guides/[...slug]/page.tsx   # Dynamic guide routes
│   └── layout.tsx                  # Docs layout with navigation
├── (guides)/        # Route group for guides listing
│   ├── guides/page.tsx             # Guides index page
│   └── layout.tsx                  # Guides layout
├── templates/       # Templates section
├── api/
│   ├── llm/[...slug]/route.ts     # LLM-friendly content API
│   ├── guide-step/route.ts        # Guide step navigation
│   └── templates/route.ts         # Templates API
└── layout.tsx       # Root layout with Pagefind loader
```

### Content Organization
```
content/
├── moosestack/      # Main documentation (supports both TS and Python)
├── guides/          # User guides (organized by category)
│   ├── applications/          # Guide category
│   ├── data-management/       # Guide category
│   ├── data-warehousing/      # Guide category
│   ├── methodology/           # Guide category
│   └── *.mdx                  # Top-level guides
├── shared/          # Reusable content fragments (excluded from routes)
├── templates/       # Template documentation
├── ai/             # AI-specific docs (feature flagged)
└── hosting/        # Hosting docs (public by default)
```

**CRITICAL**: The `shared/` folder is excluded from route generation. Content here is only used via the `include` system (see `src/lib/includes.ts`).

### Navigation System

Navigation is **manually configured** in `src/config/navigation.ts`, NOT auto-generated from file structure. This file contains:
- `moosestackNavigationConfig`: Main MooseStack docs navigation
- `guidesNavigationConfig`: Guides navigation with sections and icons
- `templatesNavigationConfig`: Templates navigation

**When adding new pages**:
1. Create the `.mdx` file in `content/`
2. Add entry to the appropriate navigation config in `src/config/navigation.ts`
3. Set icon from `@tabler/icons-react`
4. For guides, set `status: "draft"` initially

### Feature Flags

Visibility controlled via Vercel Toolbar flags:
- `show-draft-guides`: Internal WIP guides (not ready for external users)
- `show-beta-guides`: Guides ready for select external preview
- `show-ai-section`: AI tab visibility
- `show-copy-as-markdown`: Copy page as markdown button
- `show-linear-integration`: Linear integration on guide pages

**Guide promotion workflow**: draft → beta → public (remove status field)

Flags defined in `src/flags.ts`, discovery endpoint at `src/app/.well-known/vercel/flags/route.ts`.

### Content Processing

**Key libraries** (`src/lib/`):
- `content.ts`: MDX compilation, frontmatter parsing, heading extraction
- `includes.ts`: Process `{{ include "shared/path.mdx" }}` directives
- `snippet-tester.ts`: Extract and validate code snippets
- `analytics.ts`: PostHog wrapper and custom event tracking

**Content includes**: Use `{{ include "shared/fragment.mdx" }}` to reuse content. Processed via `processIncludes()` during build. Validate with `pnpm run validate:includes`.

**Search indexing**: Pagefind runs against `.search-index/` directory (generated by `scripts/generate-search-index.ts`), not directly against Next.js output. This allows fine-grained control over what gets indexed.

### Dynamic Guides

Some guides support branching paths via `guide.toml` manifests:
- See `content/guides/applications/performant-dashboards/` for example structure
- `guide.toml` defines steps and variants
- API route at `api/guide-step/route.ts` handles step navigation

## Key Files to Know

- `src/config/navigation.ts`: **ALL navigation configuration** - modify this when adding/removing pages
- `src/flags.ts`: Feature flag definitions and defaults
- `scripts/validate-includes.ts`: Validates `{{ include }}` directives before build
- `scripts/generate-search-index.ts`: Generates search-optimized content for Pagefind
- `scripts/test-snippets.ts`: Validates code snippets in documentation

## Common Tasks

### Adding a New Guide

1. Create MDX file in `content/guides/` (or category subfolder)
2. Add frontmatter:
   ```mdx
   ---
   title: Guide Title
   description: Brief description
   ---
   ```
3. Register in `src/config/navigation.ts` under `guidesNavigationConfig`:
   ```typescript
   {
     type: "page",
     slug: "guides/your-guide-name",
     title: "Your Guide Title",
     icon: IconRocket,
     languages: ["typescript", "python"],
     status: "draft", // Start as draft
   }
   ```
4. Test locally with `show-draft-guides` flag enabled

See `GUIDES_README.md` for detailed guide authoring workflow.

### Testing Code Snippets

Code snippets in documentation are validated during `pnpm test:snippets`:
- TypeScript: Syntax validation (brace matching)
- Python: Indentation validation
- Annotate snippets with `@test` directive if needed

### Environment Variables

Required for local development (`.env.local`):
```bash
# Optional but recommended for faster GitHub API rate limits
GITHUB_TOKEN=your_github_token_here

# PostHog analytics (optional for local dev)
NEXT_PUBLIC_POSTHOG_KEY=your_key
NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com

# Feature flags
FLAGS_SECRET=<auto-generated by Vercel Toolbar>
POSTHOG_PERSONAL_API_KEY=<from PostHog settings>
POSTHOG_PROJECT_ID=<from PostHog settings>
```

## Important Context

- **Monorepo integration**: This app is part of the larger MooseStack monorepo. Dependencies must be installed from the monorepo root using `pnpm install`, never from this workspace package directly.
- **Static generation**: All pages use `generateStaticParams` for SSG, but API routes remain dynamic
- **Search is static**: Pagefind provides client-side search without server dependency
- **No TypeScript/Python URL prefixes**: Unlike earlier versions, URLs don't have `/typescript` or `/python` prefixes. Language switching handled via context.
- **Route groups**: `(docs)` and `(guides)` are route groups that don't affect URLs but organize layouts
- **Component library**: Uses shadcn/ui components in `src/components/ui/`

## Related Documentation

- `IMPLEMENTATION.md`: Detailed implementation notes and architecture decisions
- `GUIDES_README.md`: Guide authoring and promotion workflow
- `FLAGS_README.md`: Feature flags setup and usage
- `README.md`: Quick start and environment setup
